<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth –°–∫–∞–Ω–µ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
            color: #333;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        h1 {
            color: #2c3e50;
            text-align: center;
            margin-bottom: 30px;
        }

        .bluetooth-status {
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: bold;
        }

        .status-available {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-unavailable {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-scanning {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .buttons-container {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }

        button {
            padding: 12px 24px;
            font-size: 16px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            min-width: 180px;
            font-weight: bold;
        }

        .primary-btn {
            background-color: #3498db;
            color: white;
        }

        .primary-btn:hover:not(:disabled) {
            background-color: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .secondary-btn {
            background-color: #2ecc71;
            color: white;
        }

        .secondary-btn:hover:not(:disabled) {
            background-color: #27ae60;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .danger-btn {
            background-color: #e74c3c;
            color: white;
        }

        .danger-btn:hover:not(:disabled) {
            background-color: #c0392b;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .devices-container {
            margin-top: 30px;
        }

        .devices-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #eee;
        }

        .devices-count {
            font-size: 14px;
            color: #7f8c8d;
        }

        .devices-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 5px;
        }

        .device-item {
            padding: 15px;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: background-color 0.2s;
        }

        .device-item:hover {
            background-color: #f8f9fa;
        }

        .device-item:last-child {
            border-bottom: none;
        }

        .device-info {
            flex-grow: 1;
        }

        .device-name {
            font-weight: bold;
            margin-bottom: 5px;
            color: #2c3e50;
        }

        .device-id {
            font-family: monospace;
            font-size: 12px;
            color: #7f8c8d;
            word-break: break-all;
        }

        .connect-btn {
            padding: 8px 16px;
            background-color: #9b59b6;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 14px;
            transition: background-color 0.2s;
        }

        .connect-btn:hover:not(:disabled) {
            background-color: #8e44ad;
        }

        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #95a5a6;
        }

        .log-container {
            margin-top: 30px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #ddd;
            max-height: 200px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .log-time {
            color: #7f8c8d;
            margin-right: 10px;
        }

        .log-info {
            color: #3498db;
        }

        .log-success {
            color: #27ae60;
        }

        .log-error {
            color: #e74c3c;
        }

        .log-warning {
            color: #f39c12;
        }

        .scan-options {
            background-color: #f8f9fa;
            padding: 20px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .scan-options h3 {
            margin-top: 0;
            margin-bottom: 15px;
        }

        .option-group {
            margin-bottom: 15px;
        }

        .option-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }

        .option-group select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        .scan-info {
            background-color: #e3f2fd;
            padding: 10px 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid #2196f3;
        }

        .bluetooth-icon {
            display: inline-block;
            width: 20px;
            height: 20px;
            background-color: #3498db;
            mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M14.88 16.29L13 18.17v-3.76m0-8.58l1.88 1.88L13 9.58m4.71-1.87L12 2h-1v7.58L6.41 5 5 6.41 10.59 12 5 17.58 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29z'/%3E%3C/svg%3E") no-repeat center;
            -webkit-mask: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath d='M14.88 16.29L13 18.17v-3.76m0-8.58l1.88 1.88L13 9.58m4.71-1.87L12 2h-1v7.58L6.41 5 5 6.41 10.59 12 5 17.58 6.41 19 11 14.41V22h1l5.71-5.71-4.3-4.29z'/%3E%3C/svg%3E") no-repeat center;
            vertical-align: middle;
            margin-right: 8px;
        }

        .device-connected .bluetooth-icon {
            background-color: #2ecc71;
            animation: pulse 2s infinite;
        }

        @media (max-width: 600px) {
            .container {
                padding: 15px;
            }

            .buttons-container {
                flex-direction: column;
                align-items: center;
            }

            button {
                width: 100%;
                max-width: 300px;
            }

            .device-item {
                flex-direction: column;
                align-items: flex-start;
            }

            .connect-btn {
                margin-top: 10px;
                align-self: flex-end;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1><span class="bluetooth-icon"></span> Bluetooth –°–∫–∞–Ω–µ—Ä —É—Å—Ç—Ä–æ–π—Å—Ç–≤</h1>

        <div id="bluetoothStatus" class="bluetooth-status">
            –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Bluetooth...
        </div>

        <div class="scan-info">
            <strong>–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è:</strong> –≠—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ —Å–∫–∞–Ω–∏—Ä—É–µ—Ç BLE (Bluetooth Low Energy) —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞. 
            –î–ª—è —Ä–∞–±–æ—Ç—ã –Ω–µ–æ–±—Ö–æ–¥–∏–º –±—Ä–∞—É–∑–µ—Ä —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π Web Bluetooth API (Chrome 56+, Edge 79+, Opera 43+).
        </div>

        <div class="scan-options">
            <h3>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è</h3>
            <div class="option-group">
                <label for="serviceFilter">–§–∏–ª—å—Ç—Ä –ø–æ —Å–µ—Ä–≤–∏—Å–∞–º:</label>
                <select id="serviceFilter">
                    <option value="all">–í—Å–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                    <option value="battery">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ —Å –±–∞—Ç–∞—Ä–µ–µ–π</option>
                    <option value="health">–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –∑–¥–æ—Ä–æ–≤—å—è</option>
                    <option value="heart_rate">–ü—É–ª—å—Å–æ–º–µ—Ç—Ä—ã</option>
                    <option value="cycling">–í–µ–ª–æ–∫–æ–º–ø—å—é—Ç–µ—Ä—ã</option>
                    <option value="generic">–û–±—â–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</option>
                </select>
            </div>
        </div>

        <div class="buttons-container">
            <button id="scanBtn" class="primary-btn" disabled>
                –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
            <button id="stopScanBtn" class="danger-btn" disabled>
                –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            </button>
            <button id="clearDevicesBtn" class="secondary-btn">
                –û—á–∏—Å—Ç–∏—Ç—å —Å–ø–∏—Å–æ–∫
            </button>
        </div>

        <div class="devices-container">
            <div class="devices-header">
                <h2>–ù–∞–π–¥–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞</h2>
                <div class="devices-count">
                    –ù–∞–π–¥–µ–Ω–æ: <span id="devicesCount">0</span> —É—Å—Ç—Ä–æ–π—Å—Ç–≤
                </div>
            </div>

            <div id="devicesList" class="devices-list">
                <div class="empty-state">
                    <div>üì∂</div>
                    <p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                    <p>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –ø–æ–∏—Å–∫–∞ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p>
                </div>
            </div>
        </div>

        <div class="log-container">
            <div class="devices-header">
                <h3>–ñ—É—Ä–Ω–∞–ª —Å–æ–±—ã—Ç–∏–π</h3>
                <button id="clearLogBtn" style="padding: 5px 10px; font-size: 12px;">–û—á–∏—Å—Ç–∏—Ç—å</button>
            </div>
            <div id="logEntries"></div>
        </div>
    </div>

    <script>
        // –û—Å–Ω–æ–≤–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
        let bluetoothAvailable = false;
        let isScanning = false;
        let discoveredDevices = new Map();
        let logEntries = [];
        let scanInterval = null;
        let scanAttempts = 0;
        const MAX_SCAN_ATTEMPTS = 10;

        // –°–µ—Ä–≤–∏—Å—ã Bluetooth –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
        const bluetoothServices = {
            all: [],
            battery: ['battery_service'],
            health: [
                'heart_rate',
                'health_thermometer',
                'glucose',
                'blood_pressure'
            ],
            heart_rate: ['heart_rate'],
            cycling: [
                'cycling_speed_and_cadence',
                'cycling_power'
            ],
            generic: ['generic_access', 'generic_attribute']
        };

        // UUID —Å–µ—Ä–≤–∏—Å–æ–≤
        const serviceUUIDs = {
            'battery_service': '0000180f-0000-1000-8000-00805f9b34fb',
            'BLE_MODBUS': '569a1102-b87f-490c-92cb-11ba5ea5167c',
            'heart_rate': '0000180d-0000-1000-8000-00805f9b34fb',
            'health_thermometer': '00001809-0000-1000-8000-00805f9b34fb',
            'glucose': '00001808-0000-1000-8000-00805f9b34fb',
            'blood_pressure': '00001810-0000-1000-8000-00805f9b34fb',
            'cycling_speed_and_cadence': '00001816-0000-1000-8000-00805f9b34fb',
            'cycling_power': '00001818-0000-1000-8000-00805f9b34fb',
            'generic_access': '00001800-0000-1000-8000-00805f9b34fb',
            'generic_attribute': '00001801-0000-1000-8000-00805f9b34fb'
        };

        // DOM —ç–ª–µ–º–µ–Ω—Ç—ã
        const bluetoothStatus = document.getElementById('bluetoothStatus');
        const scanBtn = document.getElementById('scanBtn');
        const stopScanBtn = document.getElementById('stopScanBtn');
        const clearDevicesBtn = document.getElementById('clearDevicesBtn');
        const clearLogBtn = document.getElementById('clearLogBtn');
        const devicesList = document.getElementById('devicesList');
        const devicesCount = document.getElementById('devicesCount');
        const logEntriesContainer = document.getElementById('logEntries');
        const serviceFilter = document.getElementById('serviceFilter');

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–∏—Å–∏ –≤ –∂—É—Ä–Ω–∞–ª
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = {
                timestamp,
                message,
                type
            };
            
            logEntries.push(logEntry);
            
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π
            if (logEntries.length > 50) {
                logEntries.shift();
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            updateLogDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è –∂—É—Ä–Ω–∞–ª–∞
        function updateLogDisplay() {
            logEntriesContainer.innerHTML = '';
            
            logEntries.forEach(entry => {
                const logElement = document.createElement('div');
                logElement.className = `log-entry log-${entry.type}`;
                logElement.innerHTML = `
                    <span class="log-time">[${entry.timestamp}]</span>
                    <span class="log-message">${entry.message}</span>
                `;
                logEntriesContainer.appendChild(logElement);
            });
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            logEntriesContainer.scrollTop = logEntriesContainer.scrollHeight;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ Bluetooth
        async function checkBluetoothAvailability() {
            try {
                if (!navigator.bluetooth) {
                    throw new Error('Web Bluetooth API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤ —ç—Ç–æ–º –±—Ä–∞—É–∑–µ—Ä–µ');
                }

                // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Bluetooth
                const availability = await navigator.bluetooth.getAvailability();
                
                if (availability) {
                    bluetoothAvailable = true;
                    bluetoothStatus.textContent = '‚úÖ Bluetooth –¥–æ—Å—Ç—É–ø–µ–Ω';
                    bluetoothStatus.className = 'bluetooth-status status-available';
                    scanBtn.disabled = false;
                    addLog('Bluetooth –¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'success');
                } else {
                    bluetoothAvailable = false;
                    bluetoothStatus.textContent = '‚ùå Bluetooth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ';
                    bluetoothStatus.className = 'bluetooth-status status-unavailable';
                    scanBtn.disabled = true;
                    addLog('Bluetooth –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –Ω–∞ —ç—Ç–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ', 'warning');
                }
            } catch (error) {
                bluetoothAvailable = false;
                bluetoothStatus.textContent = `‚ùå –û—à–∏–±–∫–∞: ${error.message}`;
                bluetoothStatus.className = 'bluetooth-status status-unavailable';
                scanBtn.disabled = true;
                addLog(`–û—à–∏–±–∫–∞ –ø—Ä–æ–≤–µ—Ä–∫–∏ Bluetooth: ${error.message}`, 'error');
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è UUID —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞
        function getServiceUUIDs(filter) {
            const services = bluetoothServices[filter] || [];
            return services.map(service => serviceUUIDs[service]).filter(uuid => uuid);
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function startScanning() {
            if (!bluetoothAvailable || isScanning) return;

            isScanning = true;
            updateScanningUI();
            scanAttempts = 0;
            
            addLog('–ù–∞—á–∞–ª–æ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è...', 'info');
            
            // –ó–∞–ø—É—Å–∫–∞–µ–º –ø–µ—Ä–∏–æ–¥–∏—á–µ—Å–∫–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            scanInterval = setInterval(performScan, 3000);
            
            // –°—Ä–∞–∑—É –≤—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–≤–æ–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ
            performScan();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –æ–¥–Ω–æ–≥–æ —Ü–∏–∫–ª–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        async function performScan() {
            if (!isScanning) return;
            
            if (scanAttempts >= MAX_SCAN_ATTEMPTS) {
                addLog('–î–æ—Å—Ç–∏–≥–Ω—É—Ç–æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–ø—ã—Ç–æ–∫ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'warning');
                stopScanning();
                return;
            }
            
            scanAttempts++;
            
            try {
                const filterValue = serviceFilter.value;
                const serviceUUIDs = getServiceUUIDs(filterValue);
                
                addLog(`–ü–æ–ø—ã—Ç–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è ${scanAttempts}/${MAX_SCAN_ATTEMPTS} (—Ñ–∏–ª—å—Ç—Ä: ${filterValue})`, 'info');
                
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º requestDevice —Å —Ñ–∏–ª—å—Ç—Ä–∞–º–∏
/*                const device = await navigator.bluetooth.requestDevice({
                    filters: serviceUUIDs.length > 0 ? [{ services: serviceUUIDs }] : [],
                    optionalServices: serviceUUIDs.length > 0 ? serviceUUIDs : ['battery_service'],
                    acceptAllDevices: serviceUUIDs.length === 0
                });
*/
                let device = await navigator.bluetooth.requestDevice({
                    acceptAllDevices: true,
                    optionalServices: ['569a1102-b87f-490c-92cb-11ba5ea5167c']
                })

                // –î–æ–±–∞–≤–ª—è–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –≤ —Å–ø–∏—Å–æ–∫
                await handleDiscoveredDevice(device);
                
            } catch (error) {
                if (error.name === 'NotFoundError') {
                    addLog('–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã –≤ —ç—Ç–æ–º —Ü–∏–∫–ª–µ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è', 'info');
                } else if (error.name === 'SecurityError') {
                    addLog('–î–æ—Å—Ç—É–ø –∫ Bluetooth –∑–∞–ø—Ä–µ—â–µ–Ω', 'error');
                    stopScanning();
                } else if (error.name === 'NotAllowedError') {
                    addLog('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º', 'warning');
                    stopScanning();
                } else {
                    addLog(`–û—à–∏–±–∫–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è: ${error.message}`, 'error');
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function handleDiscoveredDevice(device) {
            const deviceId = device.id;
            
            // –ï—Å–ª–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–∂–µ –µ—Å—Ç—å –≤ —Å–ø–∏—Å–∫–µ, –æ–±–Ω–æ–≤–ª—è–µ–º –µ–≥–æ
            if (discoveredDevices.has(deviceId)) {
                const existingDevice = discoveredDevices.get(deviceId);
                existingDevice.lastSeen = new Date();
                existingDevice.device = device;
                addLog(`–û–±–Ω–æ–≤–ª–µ–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device.name || 'Unknown'}`, 'info');
            } else {
                // –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
                discoveredDevices.set(deviceId, {
                    id: deviceId,
                    name: device.name || 'Unknown Device',
                    device: device,
                    firstSeen: new Date(),
                    lastSeen: new Date()
                });
                
                addLog(`–ù–∞–π–¥–µ–Ω–æ –Ω–æ–≤–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: ${device.name || 'Unknown'}`, 'success');
                updateDevicesList();
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function updateDevicesList() {
            devicesCount.textContent = discoveredDevices.size;
            
            if (discoveredDevices.size === 0) {
                devicesList.innerHTML = `
                    <div class="empty-state">
                        <div>üì∂</div>
                        <p>–£—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p>
                        <p>–ù–∞–∂–º–∏—Ç–µ "–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ" –¥–ª—è –ø–æ–∏—Å–∫–∞ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤</p>
                    </div>
                `;
                return;
            }
            
            // –°–æ—Ä—Ç–∏—Ä—É–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø–æ –≤—Ä–µ–º–µ–Ω–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è
            const sortedDevices = Array.from(discoveredDevices.values())
                .sort((a, b) => b.lastSeen - a.lastSeen);
            
            let html = '';
            
            sortedDevices.forEach(device => {
                const lastSeen = formatTimeAgo(device.lastSeen);
                
                html += `
                    <div class="device-item" data-device-id="${device.id}">
                        <div class="device-info">
                            <div class="device-name">
                                <span class="bluetooth-icon"></span>
                                ${escapeHtml(device.name)}
                            </div>
                            <div class="device-id">ID: ${device.id}</div>
                            <div style="font-size: 11px; color: #999; margin-top: 5px;">
                                –ù–∞–π–¥–µ–Ω–æ: ${lastSeen}
                            </div>
                        </div>
                        <button class="connect-btn" onclick="connectToDevice('${device.id}')">
                            –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                        </button>
                    </div>
                `;
            });
            
            devicesList.innerHTML = html;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –≤—Ä–µ–º–µ–Ω–∏
        function formatTimeAgo(date) {
            const seconds = Math.floor((new Date() - date) / 1000);
            
            if (seconds < 10) return '—Ç–æ–ª—å–∫–æ —á—Ç–æ';
            if (seconds < 60) return `${seconds} —Å–µ–∫. –Ω–∞–∑–∞–¥`;
            if (seconds < 3600) return `${Math.floor(seconds / 60)} –º–∏–Ω. –Ω–∞–∑–∞–¥`;
            return `${Math.floor(seconds / 3600)} —á. –Ω–∞–∑–∞–¥`;
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function stopScanning() {
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            
            isScanning = false;
            updateScanningUI();
            addLog('–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ', 'warning');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è UI –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
        function updateScanningUI() {
            if (isScanning) {
                bluetoothStatus.textContent = 'üîÑ –ò–¥–µ—Ç —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ Bluetooth —É—Å—Ç—Ä–æ–π—Å—Ç–≤...';
                bluetoothStatus.className = 'bluetooth-status status-scanning';
                scanBtn.disabled = true;
                stopScanBtn.disabled = false;
                scanBtn.innerHTML = '–°–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ...';
            } else {
                if (bluetoothAvailable) {
                    bluetoothStatus.textContent = '‚úÖ Bluetooth –¥–æ—Å—Ç—É–ø–µ–Ω';
                    bluetoothStatus.className = 'bluetooth-status status-available';
                }
                scanBtn.disabled = !bluetoothAvailable;
                stopScanBtn.disabled = true;
                scanBtn.innerHTML = '–ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ';
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
        async function connectToDevice(deviceId) {
            const deviceInfo = discoveredDevices.get(deviceId);
            if (!deviceInfo) return;

            try {
                addLog(`–ü–æ–ø—ã—Ç–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫: ${deviceInfo.name}`, 'info');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const connectBtn = document.querySelector(`[data-device-id="${deviceId}"] .connect-btn`);
                const originalText = connectBtn.textContent;
                connectBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ...';
                connectBtn.disabled = true;

                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º
                if (isScanning) {
                    stopScanning();
                }
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É
                const device = deviceInfo.device;
                
                // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
                device.addEventListener('gattserverdisconnected', onDisconnected);
                
                // –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è –∫ GATT —Å–µ—Ä–≤–µ—Ä—É
                const server = await device.gatt.connect();
                
                addLog(`–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫: ${deviceInfo.name}`, 'success');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º UI
                connectBtn.textContent = '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ';
                connectBtn.style.backgroundColor = '#2ecc71';
                connectBtn.disabled = true;
                
                // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –∏–∫–æ–Ω–∫–∏
                const deviceItem = connectBtn.closest('.device-item');
                deviceItem.classList.add('device-connected');

                // –ü–æ–ª—É—á–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                const deviceName = await getDeviceName(server);
                const batteryLevel = await getBatteryLevel(server);
                
                // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ–± —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ
                let infoMessage = `–£—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É:\n\n–ù–∞–∑–≤–∞–Ω–∏–µ: ${deviceInfo.name}`;
                
                if (deviceName) {
                    infoMessage += `\n–ò–º—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: ${deviceName}`;
                }
                
                if (batteryLevel !== null) {
                    infoMessage += `\n–£—Ä–æ–≤–µ–Ω—å –±–∞—Ç–∞—Ä–µ–∏: ${batteryLevel}%`;
                }
                
                infoMessage += `\n\n–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω—è—Ç—å –æ–ø–µ—Ä–∞—Ü–∏–∏ —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.`;
                
                alert(infoMessage);

                function onDisconnected() {
                    addLog(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –æ—Ç–∫–ª—é—á–µ–Ω–æ: ${deviceInfo.name}`, 'warning');
                    connectBtn.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                    connectBtn.style.backgroundColor = '';
                    connectBtn.disabled = false;
                    deviceItem.classList.remove('device-connected');
                    device.removeEventListener('gattserverdisconnected', onDisconnected);
                }

            } catch (error) {
                addLog(`–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ ${deviceInfo.name}: ${error.message}`, 'error');
                
                // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫—É
                const connectBtn = document.querySelector(`[data-device-id="${deviceId}"] .connect-btn`);
                if (connectBtn) {
                    connectBtn.textContent = '–û—à–∏–±–∫–∞';
                    connectBtn.style.backgroundColor = '#e74c3c';
                    
                    setTimeout(() => {
                        connectBtn.textContent = '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è';
                        connectBtn.style.backgroundColor = '';
                        connectBtn.disabled = false;
                    }, 2000);
                }
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∏–º–µ–Ω–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        async function getDeviceName(server) {
            try {
                const service = await server.getPrimaryService('generic_access');
                const characteristic = await service.getCharacteristic('gap.device_name');
                const value = await characteristic.readValue();
                const decoder = new TextDecoder('utf-8');
                return decoder.decode(value);
            } catch (error) {
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –±–∞—Ç–∞—Ä–µ–∏
        async function getBatteryLevel(server) {
            try {
                const service = await server.getPrimaryService('battery_service');
                const characteristic = await service.getCharacteristic('battery_level');
                const value = await characteristic.readValue();
                return value.getUint8(0);
            } catch (error) {
                return null;
            }
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ —Å–ø–∏—Å–∫–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤
        function clearDevicesList() {
            discoveredDevices.clear();
            updateDevicesList();
            addLog('–°–ø–∏—Å–æ–∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤ –æ—á–∏—â–µ–Ω', 'warning');
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—á–∏—Å—Ç–∫–∏ –∂—É—Ä–Ω–∞–ª–∞
        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        // –§—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Ä–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è HTML
        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        document.addEventListener('DOMContentLoaded', async () => {
            addLog('–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è Bluetooth —Å–∫–∞–Ω–µ—Ä–∞...', 'info');
            
            // –ù–∞–∑–Ω–∞—á–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Å–æ–±—ã—Ç–∏–π
            scanBtn.addEventListener('click', startScanning);
            stopScanBtn.addEventListener('click', stopScanning);
            clearDevicesBtn.addEventListener('click', clearDevicesList);
            clearLogBtn.addEventListener('click', clearLog);
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å Bluetooth
            await checkBluetoothAvailability();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç—É—Å –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏
            if (navigator.bluetooth) {
                navigator.bluetooth.addEventListener('availabilitychanged', (event) => {
                    bluetoothAvailable = event.value;
                    checkBluetoothAvailability();
                });
            }
            
            addLog('–ü—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ –∫ —Ä–∞–±–æ—Ç–µ', 'success');
        });

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–∫–ª—é—á–µ–Ω–∏—è —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', () => {
            stopScanning();
        });
    </script>
</body>
</html>